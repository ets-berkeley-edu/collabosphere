/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('lodash');
var assert = require('assert');

var TestsUtil = require('col-tests');
var UsersTestUtil = require('col-users/tests/util');

describe('Users', function() {

  describe('Points', function() {

    describe('Update share status', function() {

      /**
       * Test that verifies that the share points status can be updated
       */
      it('can be updated', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {

          // Verify that the share points status can be enabled
          UsersTestUtil.assertUpdateSharePoints(client1, course, true, function(me) {
            UsersTestUtil.assertGetMe(client1, course, me, function(me) {

              // Verify that the share points status can be disabled
              TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
                UsersTestUtil.assertUpdateSharePoints(client2, course, false, function(me) {
                  UsersTestUtil.assertGetMe(client2, course, me, function(me) {

                    // Verify that the share points status can be enabled after disabling
                    UsersTestUtil.assertUpdateSharePoints(client2, course, true, function(me) {
                      UsersTestUtil.assertGetMe(client2, course, me, function(me) {

                        return callback();
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies validation when updating the share points status
     */
    it('is validated', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {

        // Invalid share points status
        UsersTestUtil.assertUpdateSharePointsFails(client, course, 'Not a boolean', 400, function() {
          UsersTestUtil.assertUpdateSharePointsFails(client, course, null, 400, function() {
            UsersTestUtil.assertUpdateSharePointsFails(client, course, undefined, 400, function() {

              // Verify that the share points status can not be set back to null
              UsersTestUtil.assertUpdateSharePoints(client, course, true, function(me) {
                UsersTestUtil.assertUpdateSharePointsFails(client, course, null, 400, function() {

                  // Verify that the share points status has not been changed
                  UsersTestUtil.assertGetMe(client, course, me, function(me) {
                    assert.strictEqual(me.share_points, true);

                    return callback();
                  });
                });
              });
            });
          });
        });
      });
    });
  });
});
