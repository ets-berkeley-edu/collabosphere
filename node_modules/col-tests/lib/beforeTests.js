/**
 * Copyright Â©2017. The Regents of the University of California (Regents). All Rights Reserved.
 *
 * Permission to use, copy, modify, and distribute this software and its documentation
 * for educational, research, and not-for-profit purposes, without fee and without a
 * signed licensing agreement, is hereby granted, provided that the above copyright
 * notice, this paragraph and the following two paragraphs appear in all copies,
 * modifications, and distributions.
 *
 * Contact The Office of Technology Licensing, UC Berkeley, 2150 Shattuck Avenue,
 * Suite 510, Berkeley, CA 94720-1620, (510) 643-7201, otl@berkeley.edu,
 * http://ipira.berkeley.edu/industry-info for commercial licensing opportunities.
 *
 * IN NO EVENT SHALL REGENTS BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT, SPECIAL,
 * INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS, ARISING OUT OF
 * THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF REGENTS HAS BEEN ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * REGENTS SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE
 * SOFTWARE AND ACCOMPANYING DOCUMENTATION, IF ANY, PROVIDED HEREUNDER IS PROVIDED
 * "AS IS". REGENTS HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES,
 * ENHANCEMENTS, OR MODIFICATIONS.
 */

var _ = require('lodash');
var assert = require('assert');
var busboy = require('express-busboy');
var express = require('express');
var randomstring = require('randomstring');
var util = require('util');

var Collabosphere = require('col-core');
var DB = require('col-core/lib/db');

var TestsUtil = require('./util');

// Bootstrap the application server before the tests begin
before(function(callback) {
  // Start up server
  Collabosphere.init(function(err) {
    assert.ok(!err);

    // Create 2 Canvas instances that can be used in the tests
    createCanvas(function(ucberkeleyCanvas) {
      createCanvas(function(ucdavisCanvas) {

        // Expose the Canvas instances on the global object
        global.tests = {
          'canvas': {
            'ucberkeley': ucberkeleyCanvas,
            'ucdavis': ucdavisCanvas
          }
        };
        return callback();
      });
    });
  });
});

after(function(callback) {
  Collabosphere.appServer.httpServer.close();
  return callback();
});

/**
 * Create a dummy canvas object
 *
 * @param  {Function}     callback              Standard callback function
 * @param  {Object}       callback.canvas       The created canvas object
 * @return {Object}                             Processed canvas object
 */
var createCanvas = function(callback) {
  // Mock a canvas instance
  mockCanvasAPI(function(api_domain, canvasAppServer) {
    DB.Canvas.build({
      'canvas_api_domain': api_domain,
      'api_key': randomstring.generate(),
      'lti_key': randomstring.generate(),
      'lti_secret': randomstring.generate(),
      'use_https': false
    }).save().complete(function(err, canvas) {
      assert.ok(!err);
      canvas = canvas.dataValues;
      canvas.appServer = canvasAppServer;
      return callback(canvas);
    });
  });
};

var canvasPort = 3001;

/**
 * Mock the Canvas REST API by spinning up an express web server
 *
 * @param  {Function}         callback                    Standard callback function
 * @param  {String}           callback.apiDomain          The api domain on which the mocked REST api is available
 * @param  {Express}          callback.app                The express web server that will be used to mock the canvas API
 * @param  {Function}         callback.app.expect         A function that allows you to add an expected request
 * @return {Object}                                       Initialized mock Canvas
 * @api private
 */
var mockCanvasAPI = function(callback) {
  var app = express();

  // Holds a queue of expected requests that should hit the Canvas server
  var queue = [];

  var server = app.listen(canvasPort, function() {
    canvasPort++;

    var port = server.address().port;
    var apiDomain = util.format('localhost:%d', port);

    // Parse the incoming HTTP requests
    busboy.extend(app, {'upload': true});

    app.use(function(req, res, next) {
      if (_.isEmpty(queue)) {
        assert.fail('Was not expecting any requests reaching Canvas');
      }

      var mockedRequest = queue[0];

      // Ensure this request is something we're expecting. If this request was unexpected,
      // the queue will be reset and the failure will be thrown
      try {
        mockedRequest.isValid(req);
      } catch (err) {
        queue = [];

        throw err;
      }

      // Send the correct response back to the client
      mockedRequest.handle(req, res);

      // Remove the expected request from the queue
      queue.shift();
    });

    /**
     * Add a mocked request to the queue of expected requests
     *
     * @param  {MockedRequest}  mockedRequest   The mocked request which should be added to the queue
     * @return {void}
     */
    app.expect = function(mockedRequest) {
      queue.push(mockedRequest);
    };

    return callback(apiDomain, app);
  });
};
