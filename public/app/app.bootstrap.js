/*!
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

(function(angular) {

  var collabosphere = angular.module('collabosphere', [
    'ngAria',
    'ngCookies',
    'ng.deviceDetector',
    'ngFileUpload',
    'ngMessages',
    'ngMoment',
    'ngSanitize',
    'analytics.mixpanel',
    'common.fabric',
    'common.fabric.utilities',
    'common.fabric.constants',
    'luegg.directives',
    'mgcrea.ngStrap',
    'monospaced.elastic',
    'oi.select',
    'ui.router',

    // This module gets generated by the production build. It will expose all of the HTML partials
    // through the `templateCache`. This allows us to cache and revision HTML partials in production
    'collabosphere.templates'
  ]);

  /**
   * Get the parsed querystring parameters from the current URL
   *
   * @return {Object}                     The parsed querystring parameters from the current URL
   * @see https://css-tricks.com/snippets/jquery/get-query-params-object/
   */
  var getQueryParameters = function() {
    return decodeURIComponent(document.location.search).replace(/(^\?)/,'').split("&").map(function(n){return n = n.split("="),this[n[0]] = n[1],this}.bind({}))[0];
  }

  /**
   * Get and cache the config feed and me data before bootstrapping
   * the Collabosphere angular app to remove the need for asynchronous
   * operations during the configuration phase
   */
  var initData = function() {
    var initInjector = angular.injector(['ng']);
    var $http = initInjector.get('$http');
    var $q = initInjector.get('$q');

    // Construct the base REST API URL
    var parameters = getQueryParameters();
    var baseUrl = '/api/' + parameters.api_domain + '/' + parameters.course_id;

    return $q.all({
      'me': $http.get(baseUrl + '/users/me'),
      'config': $http.get(baseUrl + '/config'),
    }).then(function(results) {
      collabosphere.constant('me', results.me.data);
      collabosphere.constant('config', results.config.data);
    });
  };

  /**
   * Bootstrap the Collabosphere angular app
   */
  var bootstrap = function() {
    angular.element(document).ready(function() {
      angular.bootstrap(document, ['collabosphere']);
    });
  };

  initData().then(bootstrap);

})(window.angular);
